version: "3"

services:
  backend:
    build:
      context: .
      dockerfile: ops/dev/docker-compose/Dockerfile
    image: backend
    hostname: backend
    tty: true
    volumes:
      - ./backend:/backend
    ports:
      - "10000:10000"
    environment:
      - DISABLE_NEW_RELIC=true
      - NR_NAME=TP Local
      - NR_LICENSE=3289b893db560c39096d3c222d4a33037c24f943
      - NR_TRACING=true

      - API_PORT=10000
      - API_ACCOUNT_HOST=backend
      - API_ACCOUNT_PORT=10001

      - ACCOUNT_RPC_PORT=10001

      - WEBHOOK_POSTGRES_URL=postgresql://postgres:example@postgres/webhook
      - WEBHOOK_RPC_HOST=backend
      - WEBHOOK_RPC_PORT=10002
      - WEBHOOK_RABBIT_URL=amqp://tp:TheToiletPaperPassword@rabbitmq:5672/webhook
      - WEBHOOK_CLIENT_TIMEOUT=3
      - WEBHOOK_REDIS_URL=redis:6379

      - MM7_RABBIT_URL=amqp://tp:TheToiletPaperPassword@rabbitmq:5672/mm7
      - MM7_RPC_PORT=10003
      - MM7_RPC_HOST=backend
      - MM7_REDIS_URL=redis:6379
      - MM7_TECLOO_URL=http://backend:7010/v1
      - MM7_TEMPLATE_PATH=tecloo/templates
      - MM7_AWS_REGION=ap-southeast-2
      - MM7_MMS_MEDIA_BUCKET=tp.mms.media

      - TECLOO_HTTP_PORT=10004
      - TECLOO_TEMPLATE_PATH=tecloo/templates

      - TECLOO_RECEIVER_HTTP_PORT=10005
      - TECLOO_RECEIVER_TEMPLATE_PATH=tecloo_receiver/templates
      - TECLOO_RECEIVER_RABBIT_URL=amqp://tp:TheToiletPaperPassword@rabbitmq:5672/mm7
      - TECLOO_RECEIVER_RABBIT_EXCHANGE=mm7
      - TECLOO_RECEIVER_RABBIT_EXCHANGE_TYPE=direct

    deploy:
      resources:
        limits:
          cpus: "4"
    depends_on:
      - rabbitmq
      - redis
      - minio
      - miniosetup
      - postgres

  rabbitmq:
    build:
      context: .
      dockerfile: ops/dev/docker-compose/Dockerfile_rabbitmq
    hostname: rabbitmq
    ports:
      - "27651:15672"
      - "56721:5672"

  redis:
    image: redis:3.2.9
    hostname: redis
    volumes:
      - redis_data:/data

  minio:
    image: minio/minio
    hostname: minio
    command: server /data
    volumes:
      - minio_data:/data
    ports:
      - "9999:9000"
    environment:
      MINIO_ACCESS_KEY: tp
      MINIO_SECRET_KEY: fr0gsn0g
      MINIO_REGION_NAME: ap-southeast-2

  miniosetup:
    image: minio/mc
    depends_on:
      - minio
    environment:
      MINIO_ACCESS_KEY: tp
      MINIO_SECRET_KEY: fr0gsn0g
      MINIO_REGION_NAME: ap-southeast-2
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add minio http://minio:9000 $${MINIO_ACCESS_KEY} $${MINIO_SECRET_KEY} --api S3v4;
      /usr/bin/mc mb --ignore-existing --region=$${MINIO_REGION_NAME} minio/tp-csv;
      /usr/bin/mc policy set public minio/tp-csv;
      "

  postgres:
    image: postgres:11.8-alpine
    hostname: postgres
    volumes:
      - postgres_data:/data/postgres
    environment:
      POSTGRES_DB: "tp"
      POSTGRES_PASSWORD: "example"
      PGDATA: /data/postgres
    ports:
      - "54321:5432"

volumes:
  redis_data:
  rabbitmq_data:
  minio_data:
  postgres_data:
